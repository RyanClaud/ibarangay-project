/**
 * @file Firebase Security Rules for iBarangay System
 * @description This ruleset enforces a user-ownership model for residents and their document requests,
 *               while also providing role-based access for barangay officials and administrators using a role field in the user's document.
 *
 * Data Structure:
 * - /users/{userId}: Stores user accounts with a 'role' field.
 * - /residents/{residentId}: Stores resident profiles, with userId for authentication.
 * - /documentRequests/{documentRequestId}: Stores document requests, linked to residents via residentId.
 * - /payments/{paymentId}: Stores payment information for document requests.
 * - /officials/{officialId}: Stores information about barangay officials.
 * - /barangayConfig/{configId}: Stores configuration settings for the barangay.
 *
 * Key Security Decisions:
 * - The user's role is stored in their document at /users/{userId}.
 * - Authenticated users can read the list of users.
 * - Residents can only read/write their own resident profile.
 * - Staff (non-residents) can read all resident profiles.
 * - Residents can only create document requests for themselves.
 * - Staff (non-residents) can read all document requests.
 * - Admins (role == "Admin") have the highest level of privileges.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the request is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the authenticated user is the owner of the resource.
     * @param {string} userId - The user ID to compare against the authenticated user's ID.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    function getUserRole(uid) {
      return get(/databases/$(database)/documents/users/$(uid)).data.role;
    }

    /**
     * @description Checks if the authenticated user has the "Admin" role.
     */
    function isAdmin() {
      return isSignedIn() && getUserRole(request.auth.uid) == "Admin";
    }

    /**
     * @description Checks if the authenticated user is a staff member (not a "Resident").
     */
    function isStaff() {
      return isSignedIn() && getUserRole(request.auth.uid) != "Resident";
    }
    
    /**
     * @description Rules for the /users/{userId} collection.
     */
    match /users/{userId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn(); // Allow any logged-in user to see user list for role checks
      allow create: if isOwner(userId); // Users can create their own profile
      allow update: if isAdmin() || isOwner(userId);
      allow delete: if isAdmin();
    }

    /**
     * @description Rules for the /residents/{residentId} collection.
     */
    match /residents/{residentId} {
      // isOwner check is for resident user trying to get their own profile
      // residentId is their auth uid
      allow get: if isStaff() || isOwner(residentId);
      // Allow staff to list all residents.
      // Also, allow an unauthenticated query if and only if it's for the login lookup.
      allow list: if isStaff() || (request.auth == null && request.query.keys().hasOnly(['userId']));
      // Only the user themselves can create their own resident profile
      allow create: if isOwner(residentId);
      allow update: if isStaff() || isOwner(residentId);
      allow delete: if isAdmin() || isOwner(residentId);
    }

    /**
     * @description Rules for the /documentRequests/{documentRequestId} collection.
     */
    match /documentRequests/{documentRequestId} {
      allow get: if isStaff() || resource.data.residentId == request.auth.uid;
      // Allow any logged-in user to list requests to solve race condition.
      // Detailed GET rules will still protect individual documents.
      allow list: if isSignedIn();
      // A resident can only create a request for themselves.
      allow create: if request.resource.data.residentId == request.auth.uid;
      // Staff can update/delete any request. Residents can only manage their own.
      allow update, delete: if isStaff() || resource.data.residentId == request.auth.uid;
    }

    /**
     * @description Rules for the /payments/{paymentId} collection.
     * Payments are managed by staff.
     */
    match /payments/{paymentId} {
      allow read, write: if isStaff();
    }

    /**
     * @description Rules for the /officials/{officialId} collection.
     * Only Admins can manage officials.
     */
    match /officials/{officialId} {
      allow read, write: if isAdmin();
    }

    /**
     * @description Rules for the /barangayConfig/{configId} collection.
     * Publicly readable, but only writable by Admins.
     */
    match /barangayConfig/{configId} {
      allow read: if true;
      allow write: if isAdmin();
    }
  }
}

    