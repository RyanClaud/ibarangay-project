/**
 * @file Firebase Security Rules for iBarangay System
 * @description This ruleset enforces a user-ownership model for residents and their document requests,
 *               while also providing role-based access for barangay officials and administrators.
 *
 * Data Structure:
 * - /users/{userId}: Stores user accounts with a 'role' field.
 * - /residents/{residentId}: Stores resident profiles, with userId for authentication.
 * - /documentRequests/{documentRequestId}: Stores document requests, linked to residents via residentId.
 * - /payments/{paymentId}: Stores payment information for document requests.
 * - /officials/{officialId}: Stores information about barangay officials.
 * - /barangayConfig/{configId}: Stores configuration settings for the barangay.
 *
 * Key Security Decisions:
 * - Role-based access is determined by custom claims on the auth token (request.auth.token.role).
 * - Authenticated users can read their own user document.
 * - Residents can only read/write their own resident profile.
 * - Staff (non-residents) can read all resident profiles.
 * - Residents can only create document requests for themselves and read their own requests.
 * - Staff (non-residents) can read and manage all document requests.
 * - Admins have the highest level of privileges.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the request is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the authenticated user is the owner of the resource.
     * @param {string} userId - The user ID to compare against the authenticated user's ID.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Checks if the authenticated user has the "Admin" role via custom claims.
     */
    function isAdmin() {
      return isSignedIn() && request.auth.token.role == "Admin";
    }

    /**
     * @description Checks if the authenticated user is a staff member via custom claims.
     */
    function isStaff() {
      return isSignedIn() && request.auth.token.role != "Resident";
    }
    
    /**
     * @description Rules for the /users/{userId} collection.
     */
    match /users/{userId} {
      allow get: if isSignedIn();
      allow list: if isStaff() || isAdmin();
      allow create: if true; 
      allow update: if isAdmin() || isOwner(userId);
      allow delete: if isAdmin() || isOwner(userId);
    }

    /**
     * @description Rules for the /residents/{residentId} collection.
     */
    match /residents/{residentId} {
      allow get: if isStaff() || isAdmin() || isOwner(residentId);
      // Staff/Admins can list all. Unauthenticated users can query for ONE resident (for login lookup).
      allow list: if isStaff() || isAdmin() || (request.auth == null && request.query.limit == 1);
      allow create: if true;
      allow update: if isStaff() || isAdmin() || isOwner(residentId);
      allow delete: if isStaff() || isAdmin();
    }

    /**
     * @description Rules for the /documentRequests/{documentRequestId} collection.
     */
    match /documentRequests/{documentRequestId} {
      // Staff can list all requests. Residents query via a 'where' clause, which is checked at the 'get' level.
      allow list: if isStaff() || isAdmin();
      allow get: if isStaff() || isAdmin() || (resource.data.residentId == request.auth.uid);
      allow create: if request.resource.data.residentId == request.auth.uid;
      allow write: if isStaff() || isAdmin() || (resource.data.residentId == request.auth.uid);
    }

    /**
     * @description Rules for the /payments/{paymentId} collection.
     */
    match /payments/{paymentId} {
      allow read, write: if isStaff() || isAdmin();
    }

    /**
     * @description Rules for the /officials/{officialId} collection.
     */
    match /officials/{officialId} {
      allow read, write: if isAdmin();
    }

    /**
     * @description Rules for the /barangayConfig/{configId} collection.
     */
    match /barangayConfig/{configId} {
      allow read: if true;
      allow write: if isAdmin();
    }
  }
}
