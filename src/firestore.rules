/**
 * @file Firebase Security Rules for iBarangay System
 * @description This ruleset enforces a user-ownership model for residents and their document requests,
 *               while also providing role-based access for barangay officials and administrators.
 *
 * Data Structure:
 * - /users/{userId}: Stores user accounts with a 'role' field.
 * - /residents/{residentId}: Stores resident profiles, with userId for authentication.
 * - /documentRequests/{documentRequestId}: Stores document requests, linked to residents via residentId.
 * - /payments/{paymentId}: Stores payment information for document requests.
 * - /officials/{officialId}: Stores information about barangay officials.
 * - /barangayConfig/{configId}: Stores configuration settings for the barangay.
 *
 * Key Security Decisions:
 * - IMPORTANT: Role-based access should ideally be handled via Firebase Auth Custom Claims.
 * - The functions `isAdmin()` and `isStaff()` are currently permissive for development.
 * - In a production environment, you would set a `role` custom claim on the user's token
 *   and these functions would check `request.auth.token.role`.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the request is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the authenticated user is the owner of the resource.
     * @param {string} userId - The user ID to compare against the authenticated user's ID.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    /**
     * @description Checks if the authenticated user has the "Admin" role.
     *               IDEALLY, this would check a custom claim: `request.auth.token.role == "Admin"`
     *               For now, we allow any authenticated user to be an admin for development ease.
     */
    function isAdmin() {
      return isSignedIn();
    }

    /**
     * @description Checks if the authenticated user is a staff member.
     *               IDEALLY, this would check a custom claim: `request.auth.token.role != "Resident"`
     *               For now, we allow any authenticated user to be staff for development ease.
     */
    function isStaff() {
      return isSignedIn();
    }
    
    /**
     * @description Rules for the /users/{userId} collection.
     */
    match /users/{userId} {
      allow get: if isSignedIn();
      allow list: if isStaff();
      allow create: if true; 
      allow update: if isAdmin() || isOwner(userId);
      allow delete: if isAdmin() || isOwner(userId);
    }

    /**
     * @description Rules for the /residents/{residentId} collection.
     */
    match /residents/{residentId} {
      // A resident can get their own profile. Staff can get any profile.
      allow get: if isStaff() || isOwner(residentId);
      // Staff can list all residents. Unauthenticated users can query for a single resident (for login).
      allow list: if isStaff() || (request.auth == null && request.query.limit == 1);
      allow create: if true;
      allow update: if isStaff() || isOwner(residentId);
      allow delete: if isStaff();
    }

    /**
     * @description Rules for the /documentRequests/{documentRequestId} collection.
     */
    match /documentRequests/{documentRequestId} {
      allow list: if isStaff();
      allow get: if isStaff() || (resource.data.residentId == request.auth.uid);
      allow create: if request.resource.data.residentId == request.auth.uid;
      allow write: if isStaff() || (resource.data.residentId == request.auth.uid);
    }

    /**
     * @description Rules for the /payments/{paymentId} collection.
     * Payments are managed by staff.
     */
    match /payments/{paymentId} {
      allow read, write: if isStaff();
    }

    /**
     * @description Rules for the /officials/{officialId} collection.
     * Only Admins can manage officials.
     */
    match /officials/{officialId} {
      allow read, write: if isAdmin();
    }

    /**
     * @description Rules for the /barangayConfig/{configId} collection.
     * Publicly readable, but only writable by Admins.
     */
    match /barangayConfig/{configId} {
      allow read: if true;
      allow write: if isAdmin();
    }
  }
}
